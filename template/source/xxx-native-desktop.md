title: 关于 xxx-native-desktop 的思考
date: 2016-03-29 00:37:00 +0800
update: 2016-03-29 00:37:00  +0800
author: me
#cover: -/images/default.png
tags:
    - C++
    - React
    - Reactive
    - Vuejs
    - Qt
    - React-native
    - Weex
    
---

最近在思考如何基于web开发方式做一个本地应用开发框架，兼具性能和开发体验。首先毙掉hybird app的方式，比如phonegap、titanium和electron这种方案，webview做的事情太多，很多环节不可控，同时无法和本地控件进行混合使用。

<!--more-->

react-native的虚拟DOM思路个人是非常喜欢的，但是函数式方式比起mvvm的方式，代码上没有mvvm简洁，同时很多使用习惯上也有很多转变，最重要的是没有desktop版本（桌面版本是最近非常需要的）。

最近也在关注vuejs，淘宝15年双十一爆出了weex，看分享是react-native的vue版本，简称vue-native，离weex开源的时间已经不多了，阿里的同学加油啊。

weex和我需要的东西已经非常接近了，但是还是有问题:

1. 淘宝的开源都是业务优先，掺杂了过多的东西，维护也是个问题
2. 还是没有desktop

虽然desktop用hybird的方式也不差，因为机器性能本身很高，但是考虑到和本地控件还有项目本身的宿主语言交互，这个就还是不现实了。

rn和weex都是virtual dom+js bridge实现，rn是函数式的方式，而weex是mvvm的方式（使用了vue的数据监听和依赖收集，还使用mustache模板引擎），rn用的是JavascriptCore作为js引擎，weex选择了v8。

weex的几篇文章

- [对无线电商动态化方案的思考（一）](https://github.com/amfe/article/issues/13)
- [对无线电商动态化方案的思考（二）](https://github.com/amfe/article/issues/14)
- [对无线电商动态化方案的思考（三）](https://github.com/amfe/article/issues/15)

使用web开发方式是为了解决开发效率的问题，这包含两个问题：

1. 开发和调试工具的支持（现在没有比web开发的工具集和可用方案更丰富的吧）
2. 技术上的可达性和更广泛的受众（现在懂点web的多了，很多概念都不用重复解释了，到业务层最好是傻瓜化）

做框架最重要的是生态，当然某些独角兽的大公司例外，可以创造生态，更多的开发者还是向更好的生态靠拢，毕竟长期的支持和开发者的活力是做开源重要的一步。

对于桌面端，目前的跨平台的可用方案很多，有hybird的，当然我暂时是不会考虑的，因为我后续想做的东西更多地还是在native c++ 下做的，所以需要一个c++的界面后端，目前来说好的选择并不是很多，时间充足的话何以像unreal engine一样写个multidelegate版本的界面库，但是成本实在是太大了，可以暂时选用Qt作为界面后端，后期性能和灵活性上不满足再适配其它引擎。

所以我理解的xxx-native-desktop框架分为四层:

1. vm层，负责界面逻辑和数据变化监视
2. virtual-dom层，负责虚拟dom到真实dom的映射
3. js 
bridge层完成js逻辑到本地逻辑的映射，主要是数据变化和事件响应。在这一层，js操作的数据变化会触发本地的数据变化；js触发的事件会转发到本地进行事件处理。

vm层目前考虑的是vue，因为接口很讨喜，足够简单，官方文档已经有组件模块化的支持，webcomponent分为三个部分，模型、模板和样式。

- 模板遵从webomponent的方式，直接使用控件标签，语意性更好，同时拥有有限的属性支持。样式这块考虑使用facebook的css-layout作为样式支持，当然可能需要进行扩充。

- 模型这块由vm完成数据的监视和本地数据的状态的同步。

- 桥接这块比较偏向于使用servo，因为足够安全，而且同样有cef的绑定，后续也可以作为内嵌的浏览器使用，servo和v8的性能和内存占用还有待进一步测试，等数据这块的原型想清楚后会出相应的性能测试，看看在我们需要的典型场景下那种选择会更好。

``` html
<ListView class="demo-list-view">
</ListView>
<style>
  ... style here
</style>
<script>
  ... vm code here
</script>
```

这次的思考更多的是想把xxx-native这个东西和后端的c++ 应用作一个结合，主体是c++，数据源也是从c++ 这边过来的，web这一层作为界面显示逻辑的开发层，也可以理解为纯显示业务层。对性能要求更高的部分可以用native c++ 包装出更强大，性能更好的控件，同时映射到webcomponent，也可以对性能要求极高的部分直接使用本地c++编码，这是开发效率和产品性能之间的权衡，选用本地界面库实现而不是hybird也正是这个考虑。

对于数据的映射和样式的同步，我们需要足够快的js解析器和样式解析器，以保证最高的转换效率，将web开发方式带来的性能损失降低到最小。整个应用显示层都是数据驱动的，所以也是一个reactive风格的ui框架。

对于数据变化的监视本身我们在后端是有一层属性变化监视服务，如果数据来自前端，则数据变化的监视工作交给vue来做，后端接受到的是最后的数据变化，如果直接使用后端的变化监视，前端也可以响应数据变化事件来触发对应的逻辑。对于数据监视的职责可以全部放在前端也可以直接放在后端，对于性能要求高的场景，建议直接使用后端的数据监视服务，性能上更有保证。前端通过数据订阅的方式来响应数据的变化并进行处理。对于数据监视这个点还需要辅以相当数量的场景和性能测试。

下一步需要把webcomponent的规范进一步细化，确定js bridge交互的部分（数据和样式），然后是技术选型，最后进入实际的开发阶段。

写到这里真想把这个玩意叫做reactive-vue-native-desktop(rvnd).


